#!/bin/bash
# shellcheck disable=SC2183,SC2030,SC2086,SC2181,SC2031,SC2015
currentVersion="v1.1"; rev_date="7 Jan 2023"; mp="$HOME/.sendwa"; envfile="$mp/file.env"
sendthisjson="$mp/temporary.json"; rd_out=/dev/stdout
if [ ! -d "$mp" ] && [ "$1" != "--install" ]; then
  >&2 printf "%s\n" "SendWA is not installed" "Please retry this script: $0 --install"
  exit 1
fi
[ -d "$mp" ] && echo "[]" > $sendthisjson
[ -f "$envfile" ] && . $envfile
# Required Function
is_installed() { command -v $1 >/dev/null 2>&1; }
_logger() {
  [ "$1" = "n" ] && _ns="\n" && shift
  printf "%b${_ns}" "${clyl}${_not_interactive:+$(date +"[%D %T]") }${csky}$*${creset}" > $rd_out && unset _ns
}
_dogger() {
  [ "$1" = "n" ] && _ns="\n" && shift
  >&2 printf "%b${_ns}" "${clyl}${_not_interactive:+$(date +"[%D %T]") }${cred}$*${creset}" > $rd_out && unset _ns
}
_checkmark() {
  printf "\033[55G%b\n" "${cgreen}[\342\234\224]${creset}"
}
_crossmark() {
  printf "\033[55G%b\n" "${cred}[\342\235\214]${creset}"
}
_packjson() {
  _argNumber="$1"
  _argText="$2"
  if [ -n "$_is_image" ]; then
    $jq --arg thephone "$_argNumber" --arg thetext "$_argText" --rawfile theimage "$_img_file_base64" \
    '. += [{"recipient_type":"individual","to":"\($thephone)","type":"image","image":{"raw": "\($theimage)", "caption": "\($thetext)"}}]' \
    $sendthisjson > /tmp/temp.json && mv /tmp/temp.json $sendthisjson
  else
    $jq --arg thephone "$_argNumber" --arg thetext "$_argText" \
    '. += [{"recipient_type":"individual","to":"\($thephone)","type":"text","text":{"body": "\($thetext)"}}]' $sendthisjson > /tmp/temp.json && mv /tmp/temp.json $sendthisjson
  fi
}
_ask_input() {
  unset _limit _limitnum
  [ "$1" = "l" ] && _limit=y && shift
  [ "$1" = "ln" ] && _limitnum=y && shift
  _question="$1"
  _thevar="$2"
  read -ep "${clyl}${_not_interactive:+$(date +"[%D %T]") }${csky}${_question}:"$'\e[0m ' "$_thevar"; _isivar="${!_thevar}"
  if [ -n "$_limit" ]; then
    while [ "${#_isivar}" -lt 8 ]; do
      read -ep "${clyl}${_not_interactive:+$(date +"[%D %T]") }${csky}${_question} (Minimum is 8 character):"$'\e[0m ' "$_thevar"
      _isivar="${!_thevar}"
    done
  elif [ -n "$_limitnum" ]; then
    while [ "${#_isivar}" -lt 8 ] || [ -z "${_isivar##*[!0-9]*}" ]; do
      read -ep "${clyl}${_not_interactive:+$(date +"[%D %T]") }${csky}${_question} (Minimum is 8 digit):"$'\e[0m ' "$_thevar"
      _isivar="${!_thevar}"
    done
  fi
}
cleanup() {
  tput cnorm
  tput sgr0
  rm -f $sendthisjson $_img_file_base64
}
trap 'cleanup; trap - EXIT; exit' EXIT INT HUP
# End Required Function
disable_color() {
  unset cred cgreen cyellw cblue cyan csky clyl creset
}
# Coloring
if [ "$(tput colors)" -ne "256" ]; then
  disable_color
else
  if [ -t 1 ]; then
    # Non bold
    cred=$(tput sgr0; tput setaf 1 ${is_bsd:+0 0}); clyl=$(tput sgr0; tput setaf 11 ${is_bsd:+0 0})
    cgreen=$(tput sgr0; tput setaf 2 ${is_bsd:+0 0}); cyan=$(tput sgr0; tput setaf 6 ${is_bsd:+0 0})
    cyellw=$(tput sgr0; tput setaf 215 ${is_bsd:+0 0}); csky=$(tput sgr0; tput setaf 14 ${is_bsd:+0 0})
    # Reset color
    creset=$(tput sgr0)
  else
    disable_color
  fi
fi
header_intro() {
  {
    printf "${cyan}%s\n" "# # # # # # # # # # # # # # # # # # # # # #"
    printf "%s%s\n" "#${clyl} SendWA - Send Whatsapp from Terminal ! ${cyan} #"
    printf "%s\n" "# # # # # # # # # # # # # # # # # # # # # #${creset}"
  }
}
_trimspace() {
    _trimvar="$*"
    # remove leading whitespace characters
    _trimvar="${_trimvar#"${_trimvar%%[![:space:]]*}"}"
    # remove trailing whitespace characters
    _trimvar="${_trimvar%"${_trimvar##*[![:space:]]}"}"
    printf '%s' "$_trimvar"
}
contactlist() {
  [ ! -s "$mp/contact.list" ] && { _dogger n "Contact list is empty"; exit 1 ; }
  printf "+%63s+\n" | tr ' ' '-'
  printf "| %-30s | %-15s | %-10s |\n" "Contact Name" "Contact Number" "Short Name"
  printf "+%63s+\n" | tr ' ' '='
  awk -F '|' '{ printf("| %-30s | %-15s | %-10s |\n", $1, substr($2, 1, length($2)-4)"****", $3) }' "$mp/contact.list"
  printf "+%63s+\n" | tr ' ' '-'
}
# Define binary variable
_jq_path="$mp/bin/jq"
is_installed jq && jq="jq" || jq="$_jq_path/jq"
_shellect_path="$mp/bin/shellect"
shellect=$_shellect_path/shellect
# Prioritize curl over wget
if is_installed curl; then
  # 0 Implies curl
  _filegrab=c
elif is_installed wget; then
  # 1 Implies wget
  _filegrab=w
else
  _dogger n "Neither wget nor curl is exist" "Please install it first"
  exit 1
fi
_fgrab() {
  ddl_input="$1"
  if [ "$_filegrab" = "c" ]; then
    case "$ddl_input" in
      *[Jj][Pp][Gg]|[Pp][Nn][Gg]|[Jj][Pp][Ee][Gg]*) _curl_opt="-O";;
      *) _curl_opt="-o $2";;
    esac
    curl -kLs --connect-timeout 5 --retry 5 --retry-delay 0 $_curl_opt $ddl_input
  elif [ "$_filegrab" = "w" ]; then
    case "$ddl_input" in
      *[Jj][Pp][Gg]|[Pp][Nn][Gg]|[Jj][Pp][Ee][Gg]*) _wget_opt="-P";;
      *) _wget_opt="-O";;
    esac
    wget -q $_wget_opt $2 $ddl_input
  fi
}
assert_image() {
  _img_source="$1"; _is_image=y
  # Check whether input argument is link or path
  if printf '%s' "$_img_source" | grep -qE '(https?|ftp|file)://[-[:alnum:]\+&@#/%?=~_|!:,.;]+'; then
    # Download the image first
    _img_date=$(date +"%Y_%m_%d_%H_%M_%S")
    mkdir -p /tmp/tem_img_dir && cd /tmp/tem_img_dir
    _fgrab "$_img_source" .
    _thefilename=$(printf '%s' *)
    _thefilename_ext="${_thefilename#*.}"
    mv "$_thefilename" "$mp/gallery/download-${_img_date}.${_thefilename_ext}"
    rm -rf /tmp/tem_img_dir && cd - >/dev/null
    # Store the filename to variable
    _img_file="$mp/gallery/download-${_img_date}.${_thefilename_ext}"
  else
    _img_file="$_img_source"
  fi
  if ! identify "$_img_file" >/dev/null 2>&1; then
    _dogger n "Not an image file"
    exit 1
  fi
  _img_file_base64="$mp/temp_img_base64"
  echo "data:image/jpeg;base64,$(base64 -w 0 "$_img_file")" > "$_img_file_base64"
}
# Most commonly would be 64 bit
case "$(uname -m)" in
  *x86_64*|*amd64*)
  arch="x86_64"
  jq_arch="64"
  ;;
  *i?86*)
  arch="i386"
  jq_arch="32"
  ;;
  *arm*|*aarch*)
  case "$(getconf LONG_BIT)" in
    *64*) arch="aarch64";;
    *) arch="armhf";;
  esac
  ;;
  *) die "Architecture not found"; exit 1;;
esac
depencheck() {
  # jq binary
  if [ "$jq" != "jq" ] && [ ! -f "$_jq_path/jq" ]; then
    mkdir -p $_jq_path
    case "$arch" in
      "armhf"|"aarch64") jqddl="https://github.com/L1so/benchy/raw/main/binary/jq/jq_${arch}";;
      *) jqddl="https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux${jq_arch}";;
    esac
    _fgrab "$jqddl" "$_jq_path/jq"
    [ $? -eq 0 ] && chmod u+x $_jq_path/jq
  fi
  # shellect script
  mkdir -p $_shellect_path
  _fgrab "https://raw.githubusercontent.com/huijunchen9260/shellect/main/shellect" "$_shellect_path/shellect"
  [ $? -eq 0 ] && chmod u+x $shellect
}
detect_profile() {
  if [ -n "$PROFILE" -a -f "$PROFILE" ]; then
    echo "$PROFILE"
    return
  fi
  detected_profile=''
  shelltype="$(basename "/$SHELL")"

  if [ "$shelltype" = "bash" ]; then
    if [ -f "$HOME/.bashrc" ]; then
      detected_profile="$HOME/.bashrc"
    elif [ -f "$HOME/.bash_profile" ]; then
      detected_profile="$HOME/.bash_profile"
    fi
  elif [ "$shelltype" = "zsh" ]; then
    detected_profile="$HOME/.zshrc"
  fi

  if [ -z "$detected_profile" ]; then
    if [ -f "$HOME/.profile" ]; then
      detected_profile="$HOME/.profile"
    elif [ -f "$HOME/.bashrc" ]; then
      detected_profile="$HOME/.bashrc"
    elif [ -f "$HOME/.bash_profile" ]; then
      detected_profile="$HOME/.bash_profile"
    elif [ -f "$HOME/.zshrc" ]; then
      detected_profile="$HOME/.zshrc"
    fi
  fi
  echo "$detected_profile"
}
_find_by_shortname() {
  _thesn="$1"; [ ! -s "$mp/contact.list" ] && { _dogger n "Contact list is empty"; exit 1; }
  awk -v no="$_thesn" -F'|' '$NF ~ no { print $2 }' "$mp/contact.list" 2>/dev/null
}
_send() {
  if [ "$_filegrab" = "c" ]; then
    _httpcode=$(
    curl -w "%{http_code}" -s -o /dev/null \
    --location --request POST "$WA_API_URL" \
    --header "Authorization: Bearer ${WA_API_KEY}" \
    --data-binary "@${sendthisjson}"
    )
    if [ "$_httpcode" = 200 ]; then _logger n "Successfully sent message !" && return 0; else _dogger n "Request failed to get through !" && return 1; fi
  elif [ "$_filegrab" = "w" ]; then
    wget --no-check-certificate -qO /dev/null \
    --method POST --timeout=0 \
    --header "Authorization: Bearer ${WA_API_KEY}" \
    --body-file="${sendthisjson}" "$WA_API_URL"
    if [ $? -eq 0 ]; then _logger n "Successfully sent message !" && return 0; else _dogger n "Request failed to get through !" && return 1; fi
  fi
}
_send_test() {
  if [ "$_filegrab" = "c" ]; then
    curl -s -o /dev/null --location --request POST "$wa_api_url" \
    --header "Authorization: Bearer ${wa_api_key}" \
    --data-raw '{ "recipient_type": "individual", "to": "'"$wa_test_phone_number"'", "type": "text", "text": { "body": "If you receive this message, this means the test is successful" }
    }'
  elif [ "$_filegrab" = "w" ]; then
    wget --no-check-certificate -qO /dev/null \
    --method POST --timeout=0 \
    --header "Authorization: Bearer ${wa_api_key}" \
    --body-data '{ "recipient_type": "individual", "to": "'"$wa_test_phone_number"'", "type": "text", "text": { "body": "If you receive this message, this means the test is successful" }
  }' "$wa_api_url"
  fi
}
install() {
  [ -d "$mp" ] && { _logger n "Already installed"; exit 0; }
  header_intro; unset _not_interactive
  _ask_input "Please insert your API URL" wa_api_url
  _ask_input "Please insert your API Key" wa_api_key
  _ask_input ln "Please insert your (international) phone number" wa_test_phone_number
  _logger "Testing your configuration"
  _send_test
  [ $? -eq 0 ] && _checkmark || { _crossmark; exit 0 ; }
  # Install configuration file
  _logger "Installing dependency"
  depencheck
  [ $? -eq 0 ] && _checkmark || { _crossmark; exit 0 ; }
  _logger "Creating configuration file on $mp"
  mkdir -p $mp/logs $mp/bin $mp/gallery
  mv ./file.env $envfile && chmod 600 $envfile
  [ $? -eq 0 ] && _checkmark || { _crossmark; exit 0 ; }
  # Install file
  _logger "Install the script to $mp"
  _profile="$(detect_profile)"
  if [ "$_profile" ]; then
    cp "$(readlink -f $0)" "${mp}/sendwa.sh"; chmod u+x "${mp}/sendwa.sh"
    echo "alias sendwa=\"$mp/sendwa.sh\"" >> $_profile
    echo "alias sendwa-update=\"$mp/update.sh\"" >> $_profile
  fi
  [ $? -eq 0 ] && _checkmark || { _crossmark; exit 0 ; }
  # Putting api config to env file
  cat <<EOF >> $envfile
WA_API_KEY="$wa_api_key"
WA_API_URL="$wa_api_url"
WA_ALIAS_LOCATION="$_profile"
EOF
  # Closing
  printf "${cgreen}%b${creset}\n" "SendWA has been installed" "Please execute . $_profile to apply changes" > $rd_out
}
uninstall() {
  unset _not_interactive
  # Remove alias from sourced file
  [ -f "$envfile" ] && . $envfile || { _dogger n "Something went wrong please retry" && exit 1; }
  _logger "Removing SendWA alias from $WA_ALIAS_LOCATION"
  grep -v "alias sendwa=\"$mp/sendwa.sh\"" $WA_ALIAS_LOCATION > /tmp/temp_bashrc && mv /tmp/temp_bashrc $WA_ALIAS_LOCATION
  [ $? -eq 0 ] && _checkmark || { _crossmark; exit 0 ; }
  _logger "Removing directory $mp"
  rm -rf -- "$mp"
  [ $? -eq 0 ] && _checkmark || { _crossmark; exit 0 ; }
}
_split_by_comma() {
  _arr_source="$1"
  _arr_name="$2"
  _arr_source=$(tr -d "[:space:]" <<< "$_arr_source")
  IFS=',' read -ra ${_arr_name} <<< "$_arr_source"
}
formphone() {
  if [ -n "$_is_sn" ]; then
    # Converting shortname to phone number
    for sn in "${arr_shortname[@]}"; do arr_phonelist+=( $(awk -v no="$sn" -F'|' '$NF ~ no { print $2 }' "$mp/contact.list") ); done
  fi
  for phone in "${arr_phonelist[@]}"; do
    [ -z "${phone##*[!0-9]*}" ] && { _dogger n "$phone must be valid number" && return 1 ; }
    _packjson "$phone" "$_text"
  done
}
interactive() {
  # Select menu
  _menuvalue=$(printf '%s\n' "Send Message" "Add/Delete Contact" "Select from contact" | $shellect -t "Please choose your preferred action (Press Q to Quit)")
  case "$_menuvalue" in
    "Send Message")
    # Ask phone number to
    _ask_input ln "Target phone number" _arg_target_number
    while [ -z "${_arg_target_number##*[!0-9]*}" ]; do _ask_input "Target phone number (must be a number)" _arg_target_number; done
    # Ask string to be sent
    _ask_input "Type string to send" _arg_target_string
    # Ask images (if any)
    _ask_input "Images link or path (optional)" _arg_target_image
    # Validate the variable
    if [ "$_arg_target_number" ] && [ "$_arg_target_string" ]; then
      [ -n "$_arg_target_image" ] && assert_image "$_arg_target_image"
      _packjson "$_arg_target_number" "$_arg_target_string" && _send
    else
      _dogger n "One of the input is empty"; return 1
    fi
      ;;
    "Add/Delete Contact")
    _selectvalue=$(printf '%s\n' "Add Contact" "Delete Contact" | $shellect -t "Please choose your preferred action (Press Q to Quit)")
    case "$_selectvalue" in
      "Add Contact")
      # Ask Contact Name
      _ask_input "Contact name" _arg_contact_name
      _ask_input ln "Phone number" _arg_target_number
      if [ "$_arg_contact_name" ] && [ "$_arg_target_number" ]; then
        # Generating shortname
        _arg_ranum="$(awk -v min=1000 -v max=9999 'BEGIN{srand(); print int(min+rand()*(max-min+1))}')"
        _arg_contact_flower=$(echo "${_arg_contact_name%"${_arg_contact_name#?}"}" | tr '[:upper:]' '[:lower:]')
        _arg_contact_shortname="${_arg_contact_flower}${_arg_ranum}"
        # Populate contact list
        echo "$_arg_contact_name|$_arg_target_number|${_arg_contact_shortname}" >> $mp/contact.list
        _logger n "Successfully saved contact, your shortname is: $_arg_contact_shortname"
      else
        _dogger n "Error adding contact, please make sure the input is correct"
        return 1
      fi
        ;;
      "Delete Contact")
      if [ -s "$mp/contact.list" ]; then
        _subselectvalue=$(awk -F'|' '{ printf("%-25s | %-15s | %5s\n", $1, $2, $3) ; }' "$mp/contact.list" | $shellect -t "Delete selected contact")
        [ -z "$_subselectvalue" ] && return 1
        # Remove line containing list
        _arg_target_name=$(echo "$_subselectvalue" | awk -F'|' '{ gsub(/^[ \t]+|[ \t]+$/, "", $1); print $1; exit }')
        _arg_target_number=$(echo "$_subselectvalue" | awk -F'|' '{ gsub(/^[ \t]+|[ \t]+$/, "", $2); print $2; exit }')
        awk -v number="$_arg_target_number" '$0 !~ number' $mp/contact.list > $mp/temp_contact.list && mv $mp/temp_contact.list $mp/contact.list
        _logger n "Successfully deleting ${_arg_target_name} from contact list !"
      else
        _dogger n "Contact list is empty" && return 1
      fi
        ;;
    esac
    ;;
    "Select from contact")
    if [ -s "$mp/contact.list" ]; then
      _selectvalue=$(awk -F'|' '{ printf("%-25s | %-15s | %5s\n", $1, $2, $3) ; }' "$mp/contact.list" | $shellect -t "Select your contact")
      [ -z "$_selectvalue" ] && return 1
      # Process the selected list
      _arg_target_number=$(echo "$_selectvalue" | awk -F'|' '{ print $2 }')
      # Ask string to be sent
      _ask_input "Type string to send" _arg_target_string
      # Ask images (if any)
      _ask_input "Images link or path (optional)" _arg_target_image
      # Validate the variable
      if [ "$_arg_target_string" ]; then
        [ -n "$_arg_target_image" ] && assert_image "$_arg_target_image"
        _packjson "$_arg_target_number" "$_arg_target_string" && _send
      else
        _dogger n "One of the input is empty"; return 1
      fi
    else
      _dogger n "Contact list not found"
      return 1
    fi
    ;;
    "") return 1;;
  esac
}
# BEGIN OPTION PARSING
display_help() {
  cat <<'EOT'
Usage: sendwa [OPTION]...
  Options:
  -o, --number=NUM        Number to send message
  -S, --shortname=ARG     Shortname to send message
  -t, --text=STRING       Text to send
  -f, --text-file=FILE    Pick file containing string to send
  -i, --image=ARG         Send image file (ARG could be link to image or path to image)
  -l, --contact-list      Print contact list
  -q, --quiet             Quiet mode
  -h, --help              Display this help section
  -v, --version           Display version
EOT
}
usage_error () { printf "%s\n%s\n" "$1" "Try 'sendwa --help' to view available option" >&2; exit 2; }
assert_argument () { { test "$1" != "$endofline" && case "$1" in -*) >&2 printf "%s\n" "$opt: Illegal input parameter ($1)"; exit 2;; esac; } || { printf "%s\n" "$2: requires an argument" >&2 && exit 2 ; }; }
endofline=$(printf '\1\3\3\7')
if [ "$#" != 0 ]; then
  set -- "$@" "$endofline"; _not_interactive=y
  while [ "$1" != "$endofline" ]; do
    opt="$1"; shift
    case "$opt" in
      --install) install && exit 0;;
      --uninstall) uninstall && exit 0;;
      -o|--number)
      _is_num=y; phonelist="$1"
      if [ "$_is_sn" ]; then
        _dogger n "This option cannot coexist with -S"
        exit 1
      fi
      assert_argument "$1" "$opt"
      _split_by_comma "$phonelist" arr_phonelist
      shift
      ;;
      -t|--text)
      assert_argument "$1" "$opt"
      _is_text="y"; _text="$1"
      if [ "$_is_from_file" ]; then
        _dogger n "This option cannot coexist with -f"
        exit 1
      fi
      shift
      ;;
      -f|--text-file)
      _is_from_file="y"; _textfile="$1";
      if [ "$_is_text" ]; then
        _dogger n "This option cannot coexist with -t"
        exit 1
      fi
      assert_argument "$1" "$opt"
      if [ -s "$_textfile" ]; then
        _logger n "Retrieving content of $_textfile" && _text=$(cat $_textfile)
      else
        _dogger n "$_textfile is empty"; exit 1
      fi
      shift
      ;;
      -i|--image)
      _is_image=y; _img_input="$1"
      assert_argument "$1" "$opt"
      assert_image "$_img_input"
      shift
      ;;
      -S|--shortname)
      _is_sn=y; _sn_input="$1"
      if [ "$_is_num" ]; then
        _dogger n "This option cannot coexist with -o"
        exit 1
      fi
      assert_argument "$1" "$opt"
      _split_by_comma "$_sn_input" arr_shortname
      shift
      ;;
      -l|--contact-list) contactlist; exit 0;;
      -q|--quiet) rd_out=/dev/null;;
      -h|--help) display_help; exit 0;;
      -v|--version) printf "%-8s %-1s %s\n" "Version" ":" "$currentVersion" "Revision" ":" "$rev_date"; exit 0;;
      -|''|[!-]*) set -- "$@" "$opt";;
      --*=*)      set -- "${opt%%=*}" "${opt#*=}" "$@";;
      -[!-]?*)    set -- $(echo "${opt#-}" | sed 's/\(.\)/ -\1/g') "$@";;
      --)         while [ "$1" != "$endofline" ]; do set -- "$@" "$1"; shift; done;;
      -*)         usage_error "Unknown option: '$opt'";;
      *)          exit 2;;
    esac
  done
  shift
else
  # Interactive mode
  interactive; exit 0
fi
# END OPTION PARSING
main() {
  formphone && _send
}
main
